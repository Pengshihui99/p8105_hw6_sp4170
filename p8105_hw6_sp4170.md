p8105_hw6_sp4170
================
Shihui Peng
2023-12-02

load packages and basic settings..

# Problem 2

## load Central Park weather data

``` r
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2022-01-01",
    date_max = "2022-12-31") |>
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) |>
  select(name, id, everything())
```

    ## using cached file: /Users/peng_/Library/Caches/org.R-project.R/R/rnoaa/noaa_ghcnd/USW00094728.dly

    ## date created (size, mb): 2023-10-12 05:40:09.606797 (8.534)

    ## file min/max dates: 1869-01-01 / 2023-10-31

## draw 5000 samples from weather_df

I first create a function for sampling rows with size as large as 100%
of the weather_df from weather_df. Then i iterate and create 5000
samples from weather_df using this function.

``` r
boot_samp = function(df){
  sample_frac(df, replace = TRUE)
}

boot_strap =
  tibble(
    strap_number = 1:5000
  ) |> 
  mutate(
    strap_sample = map(strap_number, \(i) boot_samp(weather_df))
  )
```

## question 1: log(beta1_hat∗beta2_hat)

i first fit a linear regression model with y = tmax and covariants
including tmin and prcp for my created 5000 samples. Then i use
broom::tidy and unnest() to get estimates for tmins and prcps, select
relevant columns and unnest the list. I use pivot_wider to allow the
calculation between different rows within one column (that is, calculate
log of products of estimates of tmin and estiamtes of prcps). then, i
use mutate to calculate log(beta1_hat x beta2_hat), and draw a density
plot based on the estimates of log(beta1_hat x beta2_hat). then, i
calculate the 95%CI for log(beta1_hat x beta2_hat) estimates.

### fit linear regression and get log(beta1_hat∗beta2_hat) estimates

``` r
boot_result_para =
  boot_strap |> 
  mutate(
    model = map(strap_sample, \(df) lm(tmax ~ tmin + prcp, data = df)),
    result_para = map(model, broom::tidy)
  ) |> 
  select(strap_number, result_para) |> 
  unnest(result_para) |> 
  select(strap_number, term, estimate) |> 
  pivot_wider(
    names_from = term,
    values_from = estimate
  ) |> 
  mutate(
    log_b1b2 = log(tmin * prcp)
  )
```

    ## Warning: There was 1 warning in `mutate()`.
    ## ℹ In argument: `log_b1b2 = log(tmin * prcp)`.
    ## Caused by warning in `log()`:
    ## ! NaNs produced

``` r
# or this method????

boot_result_para =
  bootstrap(weather_df, 5000, id = "strap_number") |> 
  mutate(
    model = map(strap, \(df) lm(tmax ~ tmin + prcp, data = df)),
    result_para = map(model, broom::tidy)
  ) |> 
  select(strap_number, result_para) |> 
  unnest(result_para) |> 
  select(strap_number, term, estimate) |> 
  pivot_wider(
    names_from = term,
    values_from = estimate
  ) |> 
  mutate(
    log_b1b2 = log(tmin * prcp)
  )
```

    ## Warning: There was 1 warning in `mutate()`.
    ## ℹ In argument: `log_b1b2 = log(tmin * prcp)`.
    ## Caused by warning in `log()`:
    ## ! NaNs produced

### draw a density plot for log(beta1_hat\*beta2_hat) distribution

``` r
boot_result_para |> 
  ggplot(aes(x = log_b1b2)) + geom_density() +
  labs(x = "log(beta1_hat*beta2_hat)")
```

    ## Warning: Removed 3304 rows containing non-finite values (`stat_density()`).

<img src="p8105_hw6_sp4170_files/figure-gfm/unnamed-chunk-5-1.png" width="90%" />
descriptions:

- the distribution of the log(beta1_hat x beta2_hat) is highly
  left-skewed.
- the peak of the log(beta1_hat x beta2_hat) distribution is around
  -5.5, and the majority of the estimated log(beta1_hat x beta2_hat)
  value lies between -8.2 and -4.2.
- it is worth to notice that some values of beta1_hat x beta2_hat is
  negative, so we cannot calculate the log of them. in this case, this
  part of data is removed when we draw the density plot for estimated
  log(beta1_hat x beta2_hat).
  - for more details, 1696 out of 5000 rows are used when drawing the
    plot.

### calculate 95%CI for r^2 estimates

``` r
para_ci =
boot_result_para |> 
  mutate(
    log_b1b2_lower_ci = quantile(log_b1b2, 0.025, na.rm = TRUE),
    log_b1b2_upper_ci = quantile(log_b1b2, 0.975, na.rm = TRUE)
  ) |> 
  select(log_b1b2_lower_ci, log_b1b2_upper_ci) |> 
  distinct() 
```

- based on the output, we can tell the 95% confidence interval for
  log(beta1_hat x beta2_hat), which i use 2.5% and 97.5% quantiles to
  get, is from -8.8847595 to -4.6039854

## question 2: r^2

i first fit a linear regression model with y = tmax and covariants
including tmin and prcp for my created 5000 samples. then, i use
broom::glance to give r^2 values, select relevant columns and unnest the
list. then, i draw a density plot based on the estimates of r^2. then, i
calculate the 95%CI for r^2 estimates.

### fit linear regression and get r^2 estimates

``` r
boot_result_r2 =
  boot_strap |> 
  mutate(
    model = map(strap_sample, \(df) lm(tmax ~ tmin + prcp, data = df)),
    result_r2 = map(model, broom::glance)
  ) |> 
  select(strap_number, result_r2) |> 
  unnest(result_r2) 
```

### draw a density plot for r^2 distribution

``` r
boot_result_r2 |> 
  ggplot(aes(x = r.squared)) + geom_density() 
```

<img src="p8105_hw6_sp4170_files/figure-gfm/unnamed-chunk-8-1.png" width="90%" />
descriptions:

- the distribution of r^2 is slightly left-skewed.
- the peak of the r^2 distribution is around 0.916, and the majority of
  the estimated r^2 value lies between 0.886 and 0.932.

### calculate 95%CI for r^2 estimates

``` r
r2_ci =
boot_result_r2 |> 
  mutate(
    r2_lower_ci = quantile(r.squared, 0.025),
    r2_upper_ci = quantile(r.squared, 0.975)
  ) |> 
  select(r2_lower_ci, r2_upper_ci) |> 
  distinct()
```

- based on the output, we can tell the 95% confidence interval for r^2,
  which i use 2.5% and 97.5% quantiles to get, is from 0.8885495 to
  0.9406812
- since the 95%CI is not wide and with relatively large value, we might
  say the model can make good prediction when we do bootstrap to infer
  r^2

# Problem 3

## data import, clean, and mutate

``` r
bw_df = 
  read_csv("data/birthweight.csv") |> 
  janitor::clean_names() |> 
  mutate(
    babysex = factor(babysex, levels = c(1,2), labels = c("male", "female")),
    malform = case_when(malform == 0 ~ "absent", malform == 1 ~ "present"),
    mrace = factor(mrace, levels = c(1,2,3,4,8), labels = c("White", "Black", "Asian", "Puerto Rican", "Other")),
    frace = factor(frace, levels = c(1,2,3,4,8,9), labels = c("White", "Black", "Asian", "Puerto Rican", "Other", "Unknow"))
  ) |> 
  drop_na(bwt)
```

    ## Rows: 4342 Columns: 20
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (20): babysex, bhead, blength, bwt, delwt, fincome, frace, gaweeks, malf...
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

``` r
colSums(is.na(bw_df))
```

    ##  babysex    bhead  blength      bwt    delwt  fincome    frace  gaweeks 
    ##        0        0        0        0        0        0        0        0 
    ##  malform menarche  mheight   momage    mrace   parity  pnumlbw  pnumsga 
    ##        0        0        0        0        0        0        0        0 
    ##    ppbmi     ppwt   smoken   wtgain 
    ##        0        0        0        0

- i import the data, clean the names, and mutate my interested columns
  for further steps. I drop NULL in bwt column as this is our response
  variable. then, i check the missing value in other columns, and find
  that there are no missing data.

## fit my model

- step 1
  - from my opinion, i suppose the main effect of (1) presence of
    malformations that could affect weight (malform), (2) mother’s race
    (mrace), (3) father’s race (frace), (4) average number of cigarettes
    smoked per day during pregnancy (smoken), and (5) gestational age in
    weeks (gaweeks), will affect the baby’s birth weight. therefore, i
    fit a mixed linear regression model `fit`
  - but i find that the r^2 is pretty low, so i decide to add a new
    covariant.
- step 2
  - i decide to add one more covariant (6) baby’s length at birth
    (blength) into the model `fit`
  - r^2 greatly increase, so i decide to keep variable `blength` into my
    mode.
- step 3
  - based on step 2 parameter estimates output, i find that the variable
    `malform` is not significant. so, i remove it from the model, and
    find that the r^2 does not change. To keep my model less complex, i
    decide to remove the variable `malform`, and here it comes my final
    model: `bwt ~ mrace + frace + smoken + gaweeks + blength`

``` r
fit = lm(bwt ~ malform + mrace + frace + smoken + gaweeks, data = bw_df)

broom::tidy(fit) |> knitr::kable()
```

| term              |   estimate |   std.error |   statistic |   p.value |
|:------------------|-----------:|------------:|------------:|----------:|
| (Intercept)       |  946.73658 |  88.1469618 |  10.7404335 | 0.0000000 |
| malformpresent    |   10.84055 | 115.3598051 |   0.0939716 | 0.9251361 |
| mraceBlack        | -239.04844 |  75.1246311 |  -3.1820247 | 0.0014728 |
| mraceAsian        | -164.06515 | 117.0980037 |  -1.4010927 | 0.1612580 |
| mracePuerto Rican | -142.99483 |  73.3359175 |  -1.9498608 | 0.0512572 |
| fraceBlack        |  -48.32241 |  75.1805885 |  -0.6427512 | 0.5204196 |
| fraceAsian        |  -14.48946 | 113.2159189 |  -0.1279807 | 0.8981702 |
| fracePuerto Rican |  -53.74218 |  72.9345023 |  -0.7368554 | 0.4612502 |
| fraceOther        |  -11.34893 | 120.9308651 |  -0.0938464 | 0.9252355 |
| smoken            |  -10.91868 |   0.9463709 | -11.5374233 | 0.0000000 |
| gaweeks           |   59.65934 |   2.1830308 |  27.3286770 | 0.0000000 |

``` r
broom::glance(fit)
```

    ## # A tibble: 1 × 12
    ##   r.squared adj.r.squared sigma statistic   p.value    df  logLik    AIC    BIC
    ##       <dbl>         <dbl> <dbl>     <dbl>     <dbl> <dbl>   <dbl>  <dbl>  <dbl>
    ## 1     0.245         0.243  446.      140. 4.25e-255    10 -32639. 65303. 65379.
    ## # ℹ 3 more variables: deviance <dbl>, df.residual <int>, nobs <int>

``` r
fit = lm(bwt ~ malform + mrace + frace + smoken + gaweeks + blength, data = bw_df)

broom::tidy(fit) |> knitr::kable()
```

| term              |     estimate |  std.error |   statistic |   p.value |
|:------------------|-------------:|-----------:|------------:|----------:|
| (Intercept)       | -3842.222462 | 99.8225217 | -38.4905370 | 0.0000000 |
| malformpresent    |    54.585220 | 83.6757615 |   0.6523421 | 0.5142151 |
| mraceBlack        |  -186.901616 | 54.4958286 |  -3.4296500 | 0.0006100 |
| mraceAsian        |  -119.565412 | 84.9365696 |  -1.4077024 | 0.1592910 |
| mracePuerto Rican |   -57.606838 | 53.2096036 |  -1.0826399 | 0.2790286 |
| fraceBlack        |    11.862106 | 54.5385320 |   0.2174995 | 0.8278293 |
| fraceAsian        |    -3.506574 | 82.1180150 |  -0.0427016 | 0.9659413 |
| fracePuerto Rican |   -66.872812 | 52.9013072 |  -1.2641051 | 0.2062604 |
| fraceOther        |    26.847919 | 87.7157665 |   0.3060786 | 0.7595595 |
| smoken            |    -5.611541 |  0.6916596 |  -8.1131540 | 0.0000000 |
| gaweeks           |    24.337853 |  1.6813226 |  14.4754208 | 0.0000000 |
| blength           |   122.717751 |  1.9644437 |  62.4694680 | 0.0000000 |

``` r
broom::glance(fit)
```

    ## # A tibble: 1 × 12
    ##   r.squared adj.r.squared sigma statistic p.value    df  logLik    AIC    BIC
    ##       <dbl>         <dbl> <dbl>     <dbl>   <dbl> <dbl>   <dbl>  <dbl>  <dbl>
    ## 1     0.603         0.602  323.      597.       0    11 -31245. 62515. 62598.
    ## # ℹ 3 more variables: deviance <dbl>, df.residual <int>, nobs <int>

``` r
fit = lm(bwt ~ mrace + frace + smoken + gaweeks + blength, data = bw_df)

broom::tidy(fit) |> knitr::kable()
```

| term              |     estimate |  std.error |   statistic |   p.value |
|:------------------|-------------:|-----------:|------------:|----------:|
| (Intercept)       | -3841.183031 | 99.8031845 | -38.4875798 | 0.0000000 |
| mraceBlack        |  -186.900057 | 54.4922144 |  -3.4298488 | 0.0006096 |
| mraceAsian        |  -119.628972 | 84.9308807 |  -1.4085451 | 0.1590415 |
| mracePuerto Rican |   -57.739499 | 53.2056862 |  -1.0852129 | 0.2778878 |
| fraceBlack        |    11.714524 | 54.5344458 |   0.2148096 | 0.8299259 |
| fraceAsian        |    -3.684928 | 82.1121138 |  -0.0448768 | 0.9642076 |
| fracePuerto Rican |   -67.008632 | 52.8973891 |  -1.2667663 | 0.2053070 |
| fraceOther        |    26.545731 | 87.7087261 |   0.3026578 | 0.7621652 |
| smoken            |    -5.600023 |  0.6913883 |  -8.0996780 | 0.0000000 |
| gaweeks           |    24.330697 |  1.6811753 |  14.4724327 | 0.0000000 |
| blength           |   122.707026 |  1.9642446 |  62.4703393 | 0.0000000 |

``` r
broom::glance(fit)
```

    ## # A tibble: 1 × 12
    ##   r.squared adj.r.squared sigma statistic p.value    df  logLik    AIC    BIC
    ##       <dbl>         <dbl> <dbl>     <dbl>   <dbl> <dbl>   <dbl>  <dbl>  <dbl>
    ## 1     0.603         0.602  323.      657.       0    10 -31245. 62514. 62590.
    ## # ℹ 3 more variables: deviance <dbl>, df.residual <int>, nobs <int>
